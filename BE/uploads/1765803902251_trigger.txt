import React, {
  useEffect,
  useState,
  useCallback,
  useMemo,
  useRef,
} from "react";
import ReactDOM from "react-dom";
import {
  type NodeProps,
  type Node,
  Handle,
  Position,
  useReactFlow,
} from "@xyflow/react";
import {
  Cloud,
  Settings,
  X,
  CheckCircle,
  AlertTriangle,
  Loader2,
  Trash2,
  ChevronDown,
  ChevronRight,
  Code,
} from "lucide-react";
import oneDriveService from "../services/oneDrive.service";
import syntaxHighlight from "../utils/jsonViewer";

type FolderItem = {
  id: string;
  name: string;
  path: string;
  childCount: number;
  children: any[];
};

interface AvailableVariable {
  nodeId: string;
  nodeName: any;
  nodeType: string;
  inputs: Record<string, any>;
  outputs: Record<string, any>;
}

export const OneDriveTriggerNode: React.FC<NodeProps<Node<any>>> = ({
  id,
  data,
  selected,
}) => {
  const { setNodes, deleteElements, getNodes, getEdges } = useReactFlow();

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [connecting, setConnecting] = useState(false);
  const [loadingFolders, setLoadingFolders] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);
  const [expandedNodes, setExpandedNodes] = useState<Set<string>>(new Set());
  const [hasLoadedFolders, setHasLoadedFolders] = useState(false);

  const authPopupRef = useRef<Window | null>(null);

  const [accessToken, setAccessToken] = useState<string>(
    data?.inputs?.access_token || ""
  );
  const [triggerType, setTriggerType] = useState<string>(
    data?.inputs?.trigger_type || ""
  );
  const [folderId, setFolderId] = useState<string>(
    data?.inputs?.folder_id || ""
  );
  const [folders, setFolders] = useState<FolderItem[]>([]);

  const stopPropagation = useCallback((e: any) => e.stopPropagation(), []);

  useEffect(() => {
    const token = localStorage.getItem("onedrive_auth_result");
    if (token && token.trim()) {
      setAccessToken(token);
    }
  }, []);

  useEffect(() => {
    const listener = (event: MessageEvent) => {
      const allowed = [
        "http://localhost:3000",
        "http://localhost:5173",
        "https://nightly-dms.skill-mine.com",
      ];

      if (!allowed.includes(event.origin)) return;

      if (event.data?.type === "ONEDRIVE_AUTH" && event.data.access_token) {
        setAccessToken(event.data.access_token);
        setConnecting(false);
        setHasLoadedFolders(false);
        loadFolders(event.data.access_token);

        const popup = authPopupRef.current;
        if (popup && !popup.closed) popup.close();
      }

      if (event.data?.type === "ONEDRIVE_AUTH_ERROR") {
        setErrorMsg(event.data.error ?? "Authentication failed");
        setConnecting(false);

        const popup = authPopupRef.current;
        if (popup && !popup.closed) popup.close();
      }
    };

    window.addEventListener("message", listener);
    return () => window.removeEventListener("message", listener);
  }, []);

  useEffect(() => {
    if (!connecting) return;

    const pollInterval = setInterval(() => {
      const popup = authPopupRef.current;
      const token = localStorage.getItem("onedrive_auth_result");

      if (token && token.trim()) {
        localStorage.removeItem("onedrive_auth_result");
        setAccessToken(token);
        setConnecting(false);
        setErrorMsg(null);
        setHasLoadedFolders(false);
        loadFolders(token);

        if (!isModalOpen) {
          setIsModalOpen(true);
        }

        if (popup && !popup.closed) {
          popup.close();
          authPopupRef.current = null;
        }

        clearInterval(pollInterval);
        return;
      }

      if (popup && popup.closed && !token) {
        authPopupRef.current = null;
        setConnecting(false);
        setErrorMsg("Authentication window was closed");
        clearInterval(pollInterval);
      }
    }, 1000);

    return () => clearInterval(pollInterval);
  }, [connecting, isModalOpen]);

  const openAuthPopup = async () => {
    try {
      setConnecting(true);
      setErrorMsg(null);

      const authUrl = oneDriveService.getOneDriveLoginUrl();
      const width = 500;
      const height = 700;
      const left = window.screen.width / 2 - width / 2;
      const top = window.screen.height / 2 - height / 2;

      const popup = window.open(
        authUrl,
        "OneDriveAuthPopup",
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
      );

      if (!popup) {
        throw new Error("Popup blocked! Please allow popups for this site.");
      }

      authPopupRef.current = popup;
      popup.focus();
    } catch (err: any) {
      setErrorMsg(err?.message || "Failed to open login popup");
      setConnecting(false);
    }
  };

  const loadFolders = async (token: string) => {
    if (!token || loadingFolders) return;

    try {
      setLoadingFolders(true);
      setErrorMsg(null);

      const response = await oneDriveService.listFolders(token);

      // Check if response indicates an error
      if (response && response.success === false) {
        const errorCode = response.code || response.error?.error_code;
        const errorDesc =
          response.error?.error_description || response.error || "Unknown error";

        // If it's a 401 or JWT/token error, clear the token
        if (
          errorCode === 401 ||
          errorCode === "401" ||
          errorDesc.includes("JWT") ||
          errorDesc.includes("token") ||
          errorDesc.includes("authentication")
        ) {
          setErrorMsg(
            "Authentication failed. Token is invalid or expired. Please reconnect."
          );
          setAccessToken("");
          setFolderId("");
          setFolders([]);
          localStorage.removeItem("onedrive_auth_result");
          setHasLoadedFolders(false);
          return;
        } else {
          setErrorMsg(errorDesc);
          setHasLoadedFolders(false);
          return;
        }
      }

      let folderList: FolderItem[] = [];
      if (response && response.success && Array.isArray(response.data)) {
        folderList = response.data;
      } else if (Array.isArray(response)) {
        folderList = response;
      }

      setFolders(folderList);
      setHasLoadedFolders(true);
    } catch (err: any) {
      const errorMsg = err?.message || "Failed to load folders";

      // Check if it's a 401 error from axios
      if (err?.response?.status === 401) {
        setErrorMsg(
          "Authentication failed. Token is invalid or expired. Please reconnect."
        );
        setAccessToken("");
        setFolderId("");
        setFolders([]);
        localStorage.removeItem("onedrive_auth_result");
        setHasLoadedFolders(false);
      } else {
        setErrorMsg(errorMsg);
        setHasLoadedFolders(false);
      }
    } finally {
      setLoadingFolders(false);
    }
  };

  useEffect(() => {
    if (!isModalOpen) {
      // Reset the hasLoadedFolders flag when modal closes
      setHasLoadedFolders(false);
      return;
    }

    const pendingToken = localStorage.getItem("onedrive_auth_result");
    if (pendingToken && pendingToken.trim()) {
      setAccessToken(pendingToken);
      setHasLoadedFolders(false); // Reset flag for new token
      loadFolders(pendingToken);
      localStorage.removeItem("onedrive_auth_result");
      return;
    }

    // Only try to load folders if:
    // 1. We have a token
    // 2. We haven't loaded folders yet
    // 3. We're not currently loading
    // 4. There's no error (which would have cleared the token)
    if (
      accessToken &&
      !hasLoadedFolders &&
      !loadingFolders &&
      folders.length === 0
    ) {
      loadFolders(accessToken);
    }
  }, [isModalOpen]);

  useEffect(() => {
    // Only load folders when:
    // 1. Modal is open
    // 2. We have an access token
    // 3. We haven't loaded folders yet
    // 4. We're not currently loading
    // 5. No folders are loaded
    if (
      isModalOpen &&
      accessToken &&
      !hasLoadedFolders &&
      !loadingFolders &&
      folders.length === 0
    ) {
      loadFolders(accessToken);
    }
  }, [accessToken, isModalOpen]);

  useEffect(() => {
    if (!isModalOpen) return;

    const localStorageMonitor = setInterval(() => {
      const token = localStorage.getItem("onedrive_auth_result");

      if (token && token.trim() && token !== accessToken) {
        localStorage.removeItem("onedrive_auth_result");
        setAccessToken(token);
        setErrorMsg(null);
        setHasLoadedFolders(false); // Reset flag for new token
        loadFolders(token);
        clearInterval(localStorageMonitor);
      }
    }, 500);

    return () => clearInterval(localStorageMonitor);
  }, [isModalOpen, accessToken]);

  const extractNodeData = useCallback((nodeData: any) => {
    if (!nodeData || typeof nodeData !== "object") {
      return { inputs: {}, outputs: {} };
    }

    const outputs = nodeData.outputs || {};
    const inputs: Record<string, any> = {};
    Object.entries(nodeData).forEach(([key, value]) => {
      if (key !== "outputs" && key !== "executionStatus") inputs[key] = value;
    });

    return { inputs, outputs };
  }, []);

  const previousNodes = useMemo(() => {
    const nodes = getNodes();
    const edges = getEdges();
    const availableVariables: AvailableVariable[] = [];

    const incomingEdges = edges.filter((edge) => edge.target === id);
    incomingEdges.forEach((edge) => {
      const sourceNode = nodes.find((node) => node.id === edge.source);
      if (sourceNode) {
        const { inputs, outputs } = extractNodeData(sourceNode.data);
        availableVariables.push({
          nodeId: sourceNode.id,
          nodeName: sourceNode.data?.name || sourceNode.id,
          nodeType: sourceNode.type || "unknown",
          inputs,
          outputs,
        });
      }
    });

    return availableVariables;
  }, [id, getNodes, getEdges, isModalOpen, extractNodeData]);

  const toggleNodeExpansion = (nodeId: string) => {
    setExpandedNodes((prev) => {
      const newSet = new Set(prev);
      newSet.has(nodeId) ? newSet.delete(nodeId) : newSet.add(nodeId);
      return newSet;
    });
  };

  const handleDragStart = (
    e: React.DragEvent,
    variable: string,
    nodeName: string,
    type: "input" | "output"
  ) => {
    e.stopPropagation();
    const fullVariable =
      type === "output"
        ? `${nodeName}.outputs.${variable}`
        : `${nodeName}.inputs.${variable}`;
    e.dataTransfer.effectAllowed = "copy";
    e.dataTransfer.setData("text/plain", fullVariable);
  };

  const formatValue = (value: any): string => {
    if (value === null || value === undefined) return "null";
    if (typeof value === "object") return JSON.stringify(value, null, 2);
    if (typeof value === "boolean") return value ? "true" : "false";
    return String(value);
  };

  const handleDeleteNode = useCallback(() => {
    deleteElements({ nodes: [{ id }] });
  }, [deleteElements, id]);

  const handleDeleteClick = (e: React.MouseEvent) => {
    e.stopPropagation();
    handleDeleteNode();
  };

  useEffect(() => {
    setNodes((nds) =>
      nds.map((n) =>
        n.id === id
          ? {
              ...n,
              data: {
                ...n.data,
                inputs: {
                  access_token: accessToken,
                  trigger_type: triggerType,
                  folder_id: folderId,
                },
              },
            }
          : n
      )
    );
  }, [accessToken, triggerType, folderId, id, setNodes]);

  const validationStatus = useMemo(() => {
    const errors: string[] = [];
    if (!accessToken) errors.push("OneDrive connection required");
    if (!triggerType) errors.push("Trigger type is required");
    if (!folderId) errors.push("Folder selection is required");

    return {
      isValid: errors.length === 0,
      errors,
    };
  }, [accessToken, triggerType, folderId]);

  const hasConfig = validationStatus.isValid;
  const hasExecutionOutputs =
    data?.outputs && Object.keys(data.outputs).length > 0;

  const statusConfig = useMemo(() => {
    return hasConfig
      ? { bg: "bg-emerald-500", text: "Configured", pulse: false }
      : { bg: "bg-gray-400", text: "Not Configured", pulse: false };
  }, [hasConfig]);

  const actualOutputsJson = useMemo(() => {
    if (hasExecutionOutputs) {
      return JSON.stringify(data.outputs, null, 2);
    }
    return "";
  }, [data?.outputs, hasExecutionOutputs]);

  const highlightedActualOutputs = useMemo(() => {
    if (actualOutputsJson) {
      return syntaxHighlight(actualOutputsJson);
    }
    return "";
  }, [actualOutputsJson]);

  return (
    <>
      <div
        className={`relative bg-blue-50 border-2 rounded-xl p-4 min-w-[280px] max-w-[320px] shadow-sm transition-all ${
          !validationStatus.isValid
            ? "border-red-500 shadow-red-200"
            : selected
            ? "border-blue-500 shadow-md"
            : "border-blue-300 hover:border-blue-400"
        }`}
        onClick={stopPropagation}
      >
        <Handle
          type="source"
          position={Position.Right}
          className="w-3 h-3 bg-blue-600 border-2 border-white"
          style={{
            boxShadow: "0 0 0 4px rgba(59, 130, 246, 0.25)",
          }}
        />

        <div className="flex items-start justify-between mb-3 cursor-move">
          <div className="flex items-center gap-2.5">
            <div className="p-1.5 rounded-lg bg-blue-100">
              <Cloud className="w-4 h-4 text-blue-600" />
            </div>
            <div>
              <h3 className="font-medium text-gray-800 text-sm">
                OneDrive Trigger
              </h3>
              <div className="flex items-center gap-1.5 mt-0.5">
                <div
                  className={`w-1.5 h-1.5 rounded-full ${statusConfig.bg} ${
                    statusConfig.pulse ? "animate-pulse" : ""
                  }`}
                />
                <p className="text-xs text-gray-600">{statusConfig.text}</p>
              </div>
            </div>
          </div>
          <button
            onClick={handleDeleteClick}
            className="text-gray-500 hover:text-gray-700 p-1 rounded transition"
            title="Delete"
          >
            <Trash2 className="w-4 h-4" />
          </button>
        </div>

        {!validationStatus.isValid && (
          <div className="mb-3 p-2.5 bg-red-50 border border-red-200 rounded-lg text-xs">
            <div className="flex items-start gap-2">
              <AlertTriangle className="w-3.5 h-3.5 text-red-600 shrink-0 mt-0.5" />
              <div className="flex-1">
                <p className="font-medium text-red-900 mb-1">
                  Configuration Required
                </p>
                <ul className="text-red-700 space-y-0.5">
                  {validationStatus.errors.map((error, idx) => (
                    <li key={idx}>â€¢ {error}</li>
                  ))}
                </ul>
              </div>
            </div>
          </div>
        )}

        <div className="mb-3" onClick={stopPropagation}>
          <button
            onClick={() => setIsModalOpen(true)}
            className="w-full py-2.5 rounded-lg bg-blue-600 text-white text-xs font-medium flex justify-center gap-2 shadow-sm hover:bg-blue-700 transition-colors"
          >
            <Settings className="w-3.5 h-3.5" /> Configure Trigger
          </button>
        </div>
      </div>

      {isModalOpen &&
        ReactDOM.createPortal(
          <div
            className="fixed inset-0 bg-black/40 z-[9999] flex items-center justify-center p-4"
            onClick={() => setIsModalOpen(false)}
          >
            <div
              className="bg-white rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] overflow-hidden flex flex-col"
              onClick={stopPropagation}
            >
              <div className="flex items-center justify-between px-5 py-4 border-b">
                <div className="flex items-center gap-3">
                  <div className="p-2 bg-blue-50 rounded">
                    <Cloud className="w-5 h-5 text-blue-600" />
                  </div>
                  <div>
                    <h2 className="text-base font-semibold text-gray-900">
                      Configure OneDrive Trigger
                    </h2>
                    <p className="text-xs text-gray-500 mt-0.5">
                      Authenticate with OneDrive and configure trigger settings
                    </p>
                  </div>
                </div>
                <button
                  className="text-gray-400 p-1"
                  onClick={() => setIsModalOpen(false)}
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="flex-1 overflow-hidden flex divide-x divide-gray-200">
                <div className="w-72 bg-gray-50 overflow-y-auto p-4">
                  <h3 className="text-sm font-semibold text-gray-900 mb-1 flex items-center gap-2">
                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                    Previous Nodes
                  </h3>
                  <p className="text-xs text-gray-500 mb-3">
                    Drag fields from connected nodes
                  </p>

                  {previousNodes.length === 0 ? (
                    <div className="p-4 bg-white border border-gray-200 rounded text-center">
                      <Cloud className="w-8 h-8 mx-auto mb-2 text-gray-300" />
                      <p className="text-xs text-gray-500 font-medium">
                        No connected nodes
                      </p>
                      <p className="text-xs text-gray-400 mt-1">
                        Connect nodes to use their data
                      </p>
                    </div>
                  ) : (
                    previousNodes.map((nodeData) => {
                      const isExpanded = expandedNodes.has(nodeData.nodeId);
                      const hasOutputs =
                        Object.keys(nodeData.outputs).length > 0;
                      const hasInputs = Object.keys(nodeData.inputs).length > 0;

                      return (
                        <div
                          key={nodeData.nodeId}
                          className="bg-white border border-gray-200 rounded mb-2 shadow-sm"
                        >
                          <div
                            className="px-3 py-2 bg-white cursor-pointer hover:bg-gray-50 flex items-center justify-between"
                            onClick={() => toggleNodeExpansion(nodeData.nodeId)}
                          >
                            <div className="flex items-center gap-2">
                              {isExpanded ? (
                                <ChevronDown className="w-3.5 h-3.5 text-gray-500" />
                              ) : (
                                <ChevronRight className="w-3.5 h-3.5 text-gray-500" />
                              )}
                              <span className="text-xs font-medium text-gray-900 truncate">
                                {nodeData.nodeName}
                              </span>
                            </div>
                          </div>

                          {isExpanded && (
                            <div className="px-3 pb-2 space-y-2">
                              {hasOutputs && (
                                <div>
                                  <div className="flex items-center gap-1.5 mb-1.5">
                                    <div className="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                                    <h5 className="text-[10px] font-semibold text-gray-600 uppercase tracking-wide">
                                      Outputs
                                    </h5>
                                  </div>
                                  <div className="space-y-1">
                                    {Object.entries(nodeData.outputs).map(
                                      ([key, value]) => (
                                        <div
                                          key={key}
                                          draggable
                                          onDragStart={(e) =>
                                            handleDragStart(
                                              e,
                                              key,
                                              nodeData.nodeName,
                                              "output"
                                            )
                                          }
                                          className="border border-gray-200 rounded px-2 py-1.5 bg-white hover:bg-sky-50 cursor-move transition-colors"
                                        >
                                          <span className="block text-xs font-medium text-gray-800 truncate">
                                            {key}
                                          </span>
                                          <pre className="text-[10px] text-gray-600 bg-gray-50 mt-0.5 px-1 py-0.5 rounded overflow-x-auto whitespace-pre-wrap break-all">
                                            {formatValue(value)}
                                          </pre>
                                        </div>
                                      )
                                    )}
                                  </div>
                                </div>
                              )}

                              {hasInputs && (
                                <div>
                                  <div className="flex items-center gap-1.5 mb-1.5">
                                    <div className="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
                                    <h5 className="text-[10px] font-semibold text-gray-600 uppercase tracking-wide">
                                      Inputs
                                    </h5>
                                  </div>
                                  <div className="space-y-1">
                                    {Object.entries(nodeData.inputs).map(
                                      ([key, value]) => (
                                        <div
                                          key={key}
                                          draggable
                                          onDragStart={(e) =>
                                            handleDragStart(
                                              e,
                                              key,
                                              nodeData.nodeName,
                                              "input"
                                            )
                                          }
                                          className="border border-gray-200 rounded px-2 py-1.5 bg-white hover:bg-blue-50 cursor-move transition-colors"
                                        >
                                          <span className="block text-xs font-medium text-gray-800 truncate">
                                            {key}
                                          </span>
                                          <pre className="text-[10px] text-gray-600 bg-gray-50 mt-0.5 px-1 py-0.5 rounded overflow-x-auto whitespace-pre-wrap break-all">
                                            {formatValue(value)}
                                          </pre>
                                        </div>
                                      )
                                    )}
                                  </div>
                                </div>
                              )}

                              {!hasOutputs && !hasInputs && (
                                <p className="text-xs text-gray-400 text-center py-2">
                                  No data available
                                </p>
                              )}
                            </div>
                          )}
                        </div>
                      );
                    })
                  )}
                </div>

                <div className="flex-1 overflow-y-auto bg-white p-6">
                  {!validationStatus.isValid && (
                    <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                      <div className="flex items-start gap-3">
                        <AlertTriangle className="w-5 h-5 text-red-600 mt-0.5" />
                        <div>
                          <h4 className="text-sm font-semibold text-red-900 mb-2">
                            Configuration Issues
                          </h4>
                          <ul className="text-sm text-red-700 space-y-1 list-disc list-inside">
                            {validationStatus.errors.map((error, idx) => (
                              <li key={idx}>{error}</li>
                            ))}
                          </ul>
                        </div>
                      </div>
                    </div>
                  )}

                  <h3 className="text-lg font-semibold text-gray-900 mb-1">
                    OneDrive Trigger Configuration
                  </h3>
                  <p className="text-sm text-gray-500 mb-6">
                    Connect to OneDrive and configure trigger settings
                  </p>

                  <div className="space-y-5">
                    <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                      <h4 className="text-sm font-semibold text-gray-900 mb-2">
                        OneDrive Connection
                      </h4>
                      <p className="text-xs text-gray-500 mb-3">
                        Connect your OneDrive account. A popup will open for
                        authentication.
                      </p>

                      {accessToken ? (
                        <div className="space-y-3">
                          <div className="flex items-center gap-2 text-green-700">
                            <CheckCircle className="w-5 h-5" />
                            <div>
                              <div className="text-sm font-medium">
                                Connected
                              </div>
                              <div className="text-xs text-gray-600 mt-0.5 font-mono">
                                {accessToken.substring(0, 30)}...
                              </div>
                            </div>
                          </div>
                          <button
                            onClick={() => {
                              setAccessToken("");
                              setFolderId("");
                              setFolders([]);
                              setHasLoadedFolders(false);
                              setErrorMsg(null);
                              localStorage.removeItem("onedrive_auth_result");
                            }}
                            className="px-3 py-1.5 text-xs text-red-600 hover:bg-red-50 border border-red-200 rounded"
                          >
                            Disconnect
                          </button>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          <button
                            onClick={openAuthPopup}
                            disabled={connecting}
                            className="w-full px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                          >
                            {connecting ? (
                              <span className="inline-flex items-center gap-2">
                                <Loader2 className="w-4 h-4 animate-spin" />
                                Waiting for authentication...
                              </span>
                            ) : (
                              <span className="inline-flex items-center gap-2">
                                <Cloud className="w-4 h-4" />
                                Connect OneDrive
                              </span>
                            )}
                          </button>

                          {errorMsg && (
                            <div className="p-2 bg-red-50 border border-red-200 rounded text-xs text-red-600">
                              {errorMsg}
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {accessToken && (
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Select Folder <span className="text-red-500">*</span>
                        </label>

                        <div className="flex gap-2 mb-2">
                          <button
                            onClick={() => {
                              setHasLoadedFolders(false);
                              setErrorMsg(null);
                              loadFolders(accessToken);
                            }}
                            className="px-3 py-1.5 bg-white border border-gray-200 rounded text-sm hover:bg-gray-50 disabled:opacity-50"
                            disabled={loadingFolders}
                          >
                            {loadingFolders ? (
                              <span className="inline-flex items-center gap-2">
                                <Loader2 className="w-3 h-3 animate-spin" />
                                Loading...
                              </span>
                            ) : (
                              "Refresh Folders"
                            )}
                          </button>
                          <div className="text-xs text-gray-600 self-center">
                            {folders.length} folder
                            {folders.length !== 1 ? "s" : ""}
                          </div>
                        </div>

                        {folders.length === 0 ? (
                          <div className="p-3 bg-white border border-gray-200 rounded text-center text-xs text-gray-500">
                            No folders loaded. Click "Refresh Folders" to load.
                          </div>
                        ) : (
                          <select
                            className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            value={folderId}
                            onChange={(e) => setFolderId(e.target.value)}
                          >
                            <option value="">Select a folder...</option>
                            {folders.map((f) => (
                              <option key={f.id} value={f.id}>
                                {f.name}{" "}
                                {f.childCount > 0
                                  ? `(${f.childCount} items)`
                                  : "(empty)"}
                              </option>
                            ))}
                          </select>
                        )}
                      </div>
                    )}

                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Trigger Type <span className="text-red-500">*</span>
                      </label>
                      <select
                        value={triggerType}
                        onChange={(e) => setTriggerType(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      >
                        <option value="">Select trigger...</option>
                        <option value="EVENT_BASED">
                          Event: New file uploaded
                        </option>
                      </select>
                    </div>
                  </div>
                </div>

                <div className="w-80 bg-gray-50 overflow-y-auto p-4">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <Code className="w-4 h-4 text-blue-600" />
                      <h3 className="text-xs font-bold text-gray-900 uppercase tracking-wide">
                        Output
                      </h3>
                    </div>
                    {hasExecutionOutputs && (
                      <span className="text-[10px] font-medium px-2 py-0.5 rounded-full text-green-700 bg-green-100">
                        {`${Object.keys(data.outputs).length} fields`}
                      </span>
                    )}
                  </div>

                  {hasExecutionOutputs ? (
                    <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 font-mono text-xs overflow-x-auto">
                      <pre
                        className="whitespace-pre-wrap break-words"
                        dangerouslySetInnerHTML={{
                          __html: highlightedActualOutputs,
                        }}
                      />
                    </div>
                  ) : (
                    <div className="p-4 bg-white border-2 border-dashed border-gray-300 rounded-lg text-center">
                      <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                        <Code className="w-5 h-5 text-gray-400" />
                      </div>
                      <p className="text-xs font-medium text-gray-600">
                        No execution data
                      </p>
                      <p className="text-[10px] text-gray-400 mt-1">
                        Run the workflow to see outputs
                      </p>
                    </div>
                  )}
                </div>
              </div>

              <div className="flex items-center justify-between px-6 py-4 border-t bg-gray-50">
                <div className="flex items-center gap-2">
                  {validationStatus.isValid ? (
                    <div className="flex items-center gap-2 text-sm text-green-700">
                      <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                      <span className="font-medium">Configuration Valid</span>
                    </div>
                  ) : (
                    <div className="flex items-center gap-2 text-sm text-red-700">
                      <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                      <span className="font-medium">
                        {validationStatus.errors.length} issue(s) found
                      </span>
                    </div>
                  )}
                </div>

                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setIsModalOpen(false)}
                    className="px-4 py-2 text-sm border rounded bg-white hover:bg-gray-50"
                  >
                    Cancel
                  </button>

                  <button
                    onClick={() => setIsModalOpen(false)}
                    disabled={!validationStatus.isValid}
                    className={`px-4 py-2 text-sm rounded text-white ${
                      validationStatus.isValid
                        ? "bg-blue-600 hover:bg-blue-700"
                        : "bg-gray-300 cursor-not-allowed"
                    }`}
                  >
                    Save Settings
                  </button>
                </div>
              </div>
            </div>
          </div>,
          document.body
        )}
    </>
  );
};

export default OneDriveTriggerNode;
